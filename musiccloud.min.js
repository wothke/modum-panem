/**
* musiccloud.js: Soundcloud music playback and waveform visualization.
*
* Copyright (C) 2014 Juergen Wothke
*
* Terms of Use: This software is licensed under a CC BY-NC-SA 
* (http://creativecommons.org/licenses/by-nc-sa/4.0/).
*/
"AudioContext"in window||(window.AudioContext=window.AudioContext||window.webkitAudioContext,window.AudioContext||alert("You need a recent browser with HTML5 WebAudio support.")),"audioCtx"in window||(audioCtx=new AudioContext),window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a,b){window.setTimeout(a,1e3/60)}}();var scripts=document.getElementsByTagName("script"),path=scripts[scripts.length-1].src.split("?")[0],mydir=path.split("/").slice(0,-1).join("/")+"/",scURLprefix=mydir+"proxy.php?";WaveformDisplay=function(a){this.canvasId=a,this.waveImg=0},WaveformDisplay.prototype={updateImage:function(a){this.waveImg=0;var b=new Image;b.onload=function(){this.waveImg=b}.bind(this),b.src=a},drawWaveform:function(a,b){b=Math.min(isNaN(b)?0:b,1),a=Math.min(isNaN(a)?0:a,1),a<1&&(b=0);var c=500,d=50,e=c*b,f=.7*d,g=$(this.canvasId)[0],h=g.getContext("2d");h.save();var i="#333333",j="#232323",k="#999999",l="#b9b9b9",m="#ff5200",n="#ff3400",o="#ffd5c0",p="#ffaa80";if(h.globalAlpha=.5,1==a){var q=h.createLinearGradient(0,0,0,d);q.addColorStop(0,m),q.addColorStop(f/d,n),q.addColorStop(f/d,o),q.addColorStop(1,p),h.fillStyle=q,h.fillRect(0,0,e,d)}var r=h.createLinearGradient(0,0,0,d);r.addColorStop(0,i),r.addColorStop(f/d,j),r.addColorStop(f/d,k),r.addColorStop(1,l),h.fillStyle=r,1==a?h.fillRect(e,0,c-e,d):h.fillRect(0,0,c*a,d),h.globalAlpha=.2;var s,t=3;for(h.lineWidth=1,h.strokeStyle="rgba(255,255,255,0.3)",s=0;s<c/t;s++)h.beginPath(),h.moveTo(s*t,0),h.lineTo(s*t,d),h.stroke();if(h.globalCompositeOperation="destination-out",h.globalAlpha=.6,this.waveImg){var u=this.waveImg.width,v=this.waveImg.height;h.drawImage(this.waveImg,0,0,u*a,v,0,0,c*a,d)}h.restore(),h.restore()}};var f=audioCtx.createBiquadFilter();Filters={LOWPASS:"LOWPASS"in f?f.LOWPASS:"lowpass",HIGHPASS:"HIGHPASS"in f?f.HIGHPASS:"highpass",BANDPASS:"BANDPASS"in f?f.BANDPASS:"bandpass",LOWSHELF:"LOWSHELF"in f?f.LOWSHELF:"lowshelf",PEAKING:"PEAKING"in f?f.PEAKING:"peaking",HIGHSHELF:"HIGHSHELF"in f?f.HIGHSHELF:"highshelf",NOTCH:"NOTCH"in f?f.NOTCH:"notch",ALLPASS:"ALLPASS"in f?f.ALLPASS:"allpass",NO_FILTER:-1},Analyzers=function(a){this.beatDetector=a,this.analyzerCfg,this.once=!1},Analyzers.prototype={getAnalyzer:function(a){return this.analyzerCfg&&this.analyzerCfg.length>a?this.analyzerCfg[a][5]:null},getHiHatAnalyzer:function(){return this.getAnalyzer(0)},getBandAnalyzer:function(){return this.getAnalyzer(1)},getVolAnalyzer:function(){return this.getAnalyzer(2)},setupBeatAnalyzer:function(a,b){if(null!=this.beatDetector){var c=this.beatDetector.getBeatAnalyzerNode(b,a);c.connect(audioCtx.destination),b.connect(c)}else b.connect(audioCtx.destination)},getBeats:function(){return null==this.beatDetector?null:this.beatDetector.getBeats()},setupWebAudioNodes:function(a){if(!this.once&&this.analyzerCfg){this.once=!0;var b=audioCtx.createMediaElementSource(a);b.connect(audioCtx.destination);var c=audioCtx.createAnalyser();c.fftSize=1024,this.setupBeatAnalyzer(c,b);var d;for(d=0;d<this.analyzerCfg.length;d++){var e=this.analyzerCfg[d];if(c=audioCtx.createAnalyser(),e[5]=c,c.fftSize=e[0],e[1]==this.NO_FILTER)b.connect(c);else{var f=audioCtx.createBiquadFilter();f.type=e[1],f.frequency.value=e[2],f.Q.value=e[3],f.gain.value=e[4],b.connect(f),f.connect(c)}}}},setConfig:function(a){a&&(this.analyzerCfg=a)}},CloudPlayer=function(a,b,c,d){this.guiIdMap=a,null==this.guiIdMap&&(this.guiIdMap={player:"#player",source:"#mp3Source",loading:"#isloading",title:"#sound-title"}),this.analyzers=b,this.waveformDisplay=c,this.beatDetector=d,this.currentSong,this.playlist,this.player=null,this.running=!1},CloudPlayer.prototype={setupPlaylist:function(a,b){a.indexOf("/sets/")==-1&&(b={tracks:[b]}),this.playlist=b},setNextSong:function(){this.currentSong=(void 0!==this.currentSong?this.currentSong+1:0)%this.playlist.tracks.length;var a=this.playlist.tracks[this.currentSong],b=a.permalink_url.replace("http://","https://"),c=$(this.guiIdMap.title);return c.html('<a target="_blank" href="'+b+'">'+a.title+"</a>"),null!=this.waveformDisplay&&(this.waveformDisplay.updateImage(a.waveform_url),this.waveformDisplay.drawWaveform(1,0)),scURLprefix+b},initMusic:function(){var a=[[32,Filters.HIGHPASS,19e3,0,-40,null],[32,Filters.BANDPASS,9900,100,0,null],[32,Filters.LOWPASS,5e3,0,-40,null]];this.startMusic(a)},startMusic:function(a){this.currentSong=void 0,this.analyzers.setConfig(a);var b=document.location.hash.substring(1);if(!b.length)return null;var c=$(this.guiIdMap.player)[0];c.autoplay=!0,$(this.guiIdMap.loading).empty().append('<div class="loading"><img src="./images/loading.gif"></div>');var d=scURLprefix+b+".json";$.getJSON(d,function(a){this.setupPlaylist(b,a),c.setAttribute("src",this.setNextSong()+"/audio"),c.addEventListener("stalled",function(){$(this.guiIdMap.loading).empty().append(" "),c.play()}.bind(this)),c.addEventListener("emptied",function(){}.bind(this)),c.addEventListener("suspend",function(){}.bind(this)),c.addEventListener("canplay",function(){$(this.guiIdMap.loading).empty().append(" "),this.analyzers.setupWebAudioNodes(c),this.startProgress(c),c.play()}.bind(this)),c.addEventListener("ended",function(){c.setAttribute("src",this.setNextSong()+"/audio"),c.load()}.bind(this)),c.load()}.bind(this)).fail(function(){alert("Sorry but there is no music with perma link: "+b),$(this.guiIdMap.loading).empty().append("")})},startProgress:function(a){this.mp3Player=a,this.running=!0,this.updateProgress()},stopProgress:function(){this.running=!1},getCurrentPlayTime:function(){return this.mp3Player.currentTime?1e3*this.mp3Player.currentTime:0},updateProgress:function(){if(this.running){var a=this.getCurrentPlayTime(),b=1e3*this.mp3Player.duration,c=a/b;null!=this.waveformDisplay&&a<b&&this.waveformDisplay.drawWaveform(1,c),requestAnimFrame(function(){this.updateProgress()}.bind(this))}}};